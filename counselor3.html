<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ â€“ Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Cairo',Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#2d3748;line-height:1.6;direction:rtl}
        .dashboard-header{background:linear-gradient(135deg,#0d5c0d 0%,#1a7a1a 50%,#2d8f2d 100%);color:#fff;padding:30px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.1);position:relative;overflow:hidden}
        .dashboard-header::before{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><pattern id="g" width="100" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="white" opacity=".05"/><circle cx="90" cy="10" r="1" fill="white" opacity=".05"/><circle cx="50" cy="5" r="1" fill="white" opacity=".05"/><circle cx="30" cy="15" r="1" fill="white" opacity=".05"/><circle cx="70" cy="15" r="1" fill="white" opacity=".05"/></pattern></defs><rect width="100" height="20" fill="url(%23g)"/></svg>')}
        .logo-section{margin-bottom:20px;position:relative;z-index:2}
        .saudi-emblem{width:70px;height:70px;background:#fff;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:28px;margin-bottom:15px;box-shadow:0 15px 40px rgba(0,0,0,.3);border:4px solid rgba(255,255,255,.9);animation:pulse 3s ease-in-out infinite}
        @keyframes pulse{0%,100%{transform:scale(1);box-shadow:0 15px 40px rgba(0,0,0,.3)}50%{transform:scale(1.05);box-shadow:0 20px 50px rgba(0,0,0,.4)}}
        .header-title{font-size:32px;font-weight:800;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.3);position:relative;z-index:2}
        .header-subtitle{font-size:18px;opacity:.95;margin-bottom:8px;position:relative;z-index:2}
        .header-info{font-size:15px;opacity:.85;position:relative;z-index:2}
        .refresh-indicator{position:absolute;top:20px;left:20px;background:rgba(255,255,255,.2);padding:10px 15px;border-radius:25px;font-size:14px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.3)}
        .refresh-indicator.loading{animation:shimmer 2s ease-in-out infinite}
        @keyframes shimmer{0%,100%{opacity:.7}50%{opacity:1}}
        .main-container{max-width:1600px;margin:0 auto;padding:30px 20px}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-bottom:40px}
        .stat-card{background:linear-gradient(145deg,#fff 0%,#f8fafc 100%);padding:35px;border-radius:25px;text-align:center;box-shadow:0 15px 35px rgba(0,0,0,.1);transition:all .4s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden}
        .stat-card::before{content:"";position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,#0d5c0d,#2d8f2d)}
        .stat-card::after{content:"";position:absolute;top:-50%;right:-50%;width:100%;height:200%;background:linear-gradient(45deg,transparent,rgba(13,92,13,.03),transparent);transform:rotate(45deg);transition:all .6s ease;opacity:0}
        .stat-card:hover{transform:translateY(-15px);box-shadow:0 25px 50px rgba(0,0,0,.2)}
        .stat-card:hover::after{opacity:1;top:-100%;right:-100%}
        .stat-icon{font-size:42px;margin-bottom:20px;height:70px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(13,92,13,.1),rgba(45,143,45,.1));border-radius:20px;margin:0 auto 20px;width:70px}
        .stat-number{font-size:48px;font-weight:800;color:#0d5c0d;margin-bottom:10px;text-shadow:2px 2px 4px rgba(13,92,13,.1)}
        .stat-label{color:#4a5568;font-weight:600;font-size:16px}
        .stat-change{font-size:13px;margin-top:12px;padding:6px 12px;border-radius:15px;display:inline-block;font-weight:600}
        .stat-change.positive{background:linear-gradient(135deg,#c6f6d5,#9ae6b4);color:#2f855a}
        .control-panel,.export-options,.students-section{background:linear-gradient(145deg,#fff 0%,#f8fafc 100%);border-radius:25px;padding:40px;margin-bottom:30px;box-shadow:0 15px 35px rgba(0,0,0,.1);border:1px solid rgba(13,92,13,.1)}
        .panel-title{font-size:26px;font-weight:700;color:#0d5c0d;margin-bottom:30px;display:flex;align-items:center;gap:15px;text-shadow:1px 1px 2px rgba(13,92,13,.1)}
        .control-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-bottom:30px}
        .control-group{display:flex;flex-direction:column;gap:10px}
        .control-label{font-weight:600;color:#2d3748;font-size:15px;margin-bottom:5px}
        .control-input,.control-select{padding:15px 20px;border:2px solid #e2e8f0;border-radius:15px;font-size:15px;font-family:inherit;transition:all .3s ease;background:linear-gradient(145deg,#fff 0%,#f8fafc 100%);color:#2d3748}
        .control-input:focus,.control-select:focus{outline:none;border-color:#0d5c0d;box-shadow:0 0 0 4px rgba(13,92,13,.1);background:#fff;transform:translateY(-1px)}
        .control-select{cursor:pointer;appearance:none;background-image:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%230d5c0d"><path d="M7 10l5 5 5-5z"/></svg>');background-repeat:no-repeat;background-position:left 15px center;background-size:18px;padding-left:45px}
        .action-buttons{display:flex;flex-wrap:wrap;gap:15px;justify-content:center;align-items:center}
        .action-btn{padding:15px 30px;border:none;border-radius:15px;font-size:15px;font-weight:600;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:10px;font-family:inherit;min-width:160px;justify-content:center;text-transform:uppercase;letter-spacing:.5px;position:relative;overflow:hidden}
        .action-btn::before{content:"";position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .6s ease}
        .action-btn:hover::before{left:100%}
        .btn-primary{background:linear-gradient(135deg,#0d5c0d 0%,#2d8f2d 100%);color:#fff;box-shadow:0 8px 25px rgba(13,92,13,.3)}
        .btn-secondary{background:linear-gradient(135deg,#4299e1 0%,#3182ce 100%);color:#fff;box-shadow:0 8px 25px rgba(66,153,225,.3)}
        .btn-success{background:linear-gradient(135deg,#48bb78 0%,#38a169 100%);color:#fff;box-shadow:0 8px 25px rgba(72,187,120,.3)}
        .btn-warning{background:linear-gradient(135deg,#ed8936 0%,#dd6b20 100%);color:#fff;box-shadow:0 8px 25px rgba(237,137,54,.3)}
        .btn-info{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;box-shadow:0 8px 25px rgba(102,126,234,.3)}
        .btn-danger{background:linear-gradient(135deg,#e53e3e 0%,#c53030 100%);color:#fff;box-shadow:0 8px 25px rgba(229,62,62,.3)}
        .action-btn:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(0,0,0,.3)}
        .action-btn:active{transform:translateY(-1px)}
        .export-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:25px}
        .students-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:25px}
        .students-list{display:none}.students-list.active{display:block}.students-grid.active{display:grid}
        .student-card{background:linear-gradient(145deg,#fff 0%,#f8fafc 100%);border:2px solid #f0f4f8;border-radius:20px;padding:25px;transition:all .4s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden;cursor:pointer}
        .student-card::before{content:"";position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,#0d5c0d,#2d8f2d)}
        .student-card:hover{border-color:#0d5c0d;transform:translateY(-8px);box-shadow:0 20px 40px rgba(0,0,0,.15)}
        .student-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px}
        .student-name{font-size:20px;font-weight:700;color:#0d5c0d;margin-bottom:8px;text-shadow:1px 1px 2px rgba(13,92,13,.1)}
        .student-id{font-size:13px;color:#718096;font-weight:500}
        .student-status{padding:6px 12px;border-radius:15px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
        .status-normal{background:linear-gradient(135deg,#c6f6d5,#9ae6b4);color:#2f855a}
        .status-needs-help{background:linear-gradient(135deg,#fed7d7,#fbb6ce);color:#c53030}
        .status-disability{background:linear-gradient(135deg,#bee3f8,#90cdf4);color:#2b77cb}
        .status-talented{background:linear-gradient(135deg,#faf089,#f6e05e);color:#744210}
        .student-info{display:grid;gap:12px;margin-bottom:20px}
        .info-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e2e8f0}
        .info-label{font-size:13px;color:#4a5568;font-weight:600}
        .info-value{font-size:14px;color:#2d3748;font-weight:500}
        .student-actions{display:flex;gap:10px;justify-content:center}
        .student-btn{flex:1;padding:10px 15px;border:none;border-radius:12px;font-size:12px;font-weight:600;cursor:pointer;transition:all .3s ease;text-transform:uppercase;letter-spacing:.5px}
        .btn-view{background:linear-gradient(135deg,#4299e1,#3182ce);color:#fff;box-shadow:0 4px 15px rgba(66,153,225,.3)}
        .btn-edit{background:linear-gradient(135deg,#ed8936,#dd6b20);color:#fff;box-shadow:0 4px 15px rgba(237,137,54,.3)}
        .btn-delete{background:linear-gradient(135deg,#e53e3e,#c53030);color:#fff;box-shadow:0 4px 15px rgba(229,62,62,.3)}
        .student-btn:hover{transform:translateY(-2px);opacity:.9}
        .student-list-item{display:flex;align-items:center;padding:20px;border:2px solid #e2e8f0;border-radius:15px;margin-bottom:15px;transition:all .3s ease;background:linear-gradient(145deg,#fff 0%,#f8fafc 100%);cursor:pointer}
        .student-list-item:hover{border-color:#0d5c0d;box-shadow:0 8px 25px rgba(0,0,0,.1);transform:translateY(-2px)}
        .list-avatar{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#0d5c0d,#2d8f2d);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;margin-left:20px;font-size:18px}
        .list-info{flex:1}.list-name{font-size:18px;font-weight:700;color:#0d5c0d;margin-bottom:6px}
        .list-details{font-size:14px;color:#4a5568;line-height:1.5}
        .list-status{display:flex;gap:10px;align-items:center;margin-left:20px}
        .list-actions{display:flex;gap:8px;margin-left:20px}
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .modal-content{background:linear-gradient(145deg,#fff 0%,#f8fafc 100%);margin:50px auto;padding:40px;border-radius:25px;width:95%;max-width:900px;max-height:85vh;overflow-y:auto;position:relative;box-shadow:0 25px 60px rgba(0,0,0,.3);animation:slideUp .4s ease}
        @keyframes slideUp{from{transform:translateY(50px);opacity:0}to{transform:translateY(0);opacity:1}}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid rgba(13,92,13,.1)}
        .modal-title{font-size:28px;font-weight:700;color:#0d5c0d;text-shadow:1px 1px 2px rgba(13,92,13,.1)}
        .close-btn{background:linear-gradient(135deg,#f56565,#e53e3e);border:none;font-size:20px;cursor:pointer;color:#fff;padding:10px;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;transition:all .3s ease;box-shadow:0 4px 15px rgba(245,101,101,.3)}
        .close-btn:hover{transform:rotate(90deg) scale(1.1);box-shadow:0 8px 25px rgba(245,101,101,.4)}
        .modal-body{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:30px}
        .info-section{background:linear-gradient(145deg,#f8fafc 0%,#e2e8f0 100%);padding:25px;border-radius:20px;border:2px solid rgba(13,92,13,.1)}
        .section-title-modal{font-size:18px;font-weight:700;color:#0d5c0d;margin-bottom:20px;display:flex;align-items:center;gap:10px;text-shadow:1px 1px 2px rgba(13,92,13,.1)}
        .info-grid{display:grid;gap:12px}
        .loading{display:flex;align-items:center;justify-content:center;padding:60px;color:#4a5568}
        .spinner{width:40px;height:40px;border:4px solid #e2e8f0;border-top:4px solid #0d5c0d;border-radius:50%;animation:spin 1s linear infinite;margin-left:15px}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .empty-state{text-align:center;padding:80px 30px;color:#718096}
        .empty-icon{font-size:80px;margin-bottom:25px;opacity:.7}
        .empty-title{font-size:24px;font-weight:600;margin-bottom:15px;color:#4a5568}
        .empty-description{font-size:16px;line-height:1.6}
        .connection-status{position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#48bb78,#38a169);color:#fff;padding:10px 20px;border-radius:25px;font-size:13px;font-weight:600;box-shadow:0 8px 25px rgba(72,187,120,.3);z-index:999;transition:all .3s ease}
        .connection-status.disconnected{background:linear-gradient(135deg,#f56565,#e53e3e);box-shadow:0 8px 25px rgba(245,101,101,.3)}
        @media (max-width:768px){.main-container{padding:20px 15px}.dashboard-header{padding:25px 20px}.header-title{font-size:26px}.control-panel,.students-section,.export-options{padding:25px 20px}.control-grid{grid-template-columns:1fr}.action-buttons{flex-direction:column;align-items:stretch}.action-btn{min-width:unset}.students-grid{grid-template-columns:1fr}.section-header{flex-direction:column;align-items:stretch;gap:20px}.modal-content{margin:20px;width:calc(100% - 40px);padding:25px}.modal-body{grid-template-columns:1fr}.connection-status{top:10px;right:10px;padding:8px 15px;font-size:12px}}
    </style>
</head>
<body>
<!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø§ØªØµØ§Ù„ -->
<div class="connection-status" id="connectionStatus">ğŸ”— Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>

<!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
<div class="dashboard-header">
    <div class="refresh-indicator" id="refreshIndicator">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="lastUpdate">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></div>
    <div class="logo-section"><div class="saudi-emblem">ğŸ‡¸ğŸ‡¦</div></div>
    <h1 class="header-title">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</h1>
    <div class="header-subtitle">Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ | Ù…ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹ÙˆØ§Ù„ÙŠ</div>
    <div class="header-info">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø®Ø§Ù„Ø¯ Ø³Ø¹ÙˆØ¯ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ</div>
</div>

<!-- Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div class="main-container">
    <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon">ğŸ‘¥</div><div class="stat-number" id="totalStudents">0</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</div><div class="stat-change positive" id="totalChange">+0 Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div></div>
        <div class="stat-card"><div class="stat-icon">ğŸ’°</div><div class="stat-number" id="studentsNeedHelp">0</div><div class="stat-label">Ø·Ù„Ø§Ø¨ Ù…Ø­ØªØ§Ø¬ÙˆÙ† Ù…Ø§Ù„ÙŠØ§Ù‹</div><div class="stat-change positive" id="needHelpPercentage">0%</div></div>
        <div class="stat-card"><div class="stat-icon">â™¿</div><div class="stat-number" id="studentsWithDisabilities">0</div><div class="stat-label">Ø·Ù„Ø§Ø¨ Ø°ÙˆÙˆ Ø¥Ø¹Ø§Ù‚Ø©</div><div class="stat-change positive" id="disabilityPercentage">0%</div></div>
        <div class="stat-card"><div class="stat-icon">â­</div><div class="stat-number" id="studentsWithTalents">0</div><div class="stat-label">Ø·Ù„Ø§Ø¨ Ù…ÙˆÙ‡ÙˆØ¨ÙˆÙ†</div><div class="stat-change positive" id="talentsPercentage">0%</div></div>
        <div class="stat-card"><div class="stat-icon">ğŸš¨</div><div class="stat-number" id="studentsWithProblems">0</div><div class="stat-label">Ø­Ø§Ù„Ø§Øª ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©</div><div class="stat-change positive" id="problemsPercentage">0%</div></div>
        <div class="stat-card"><div class="stat-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div><div class="stat-number" id="orphanStudents">0</div><div class="stat-label">Ø£ÙŠØªØ§Ù… ÙˆØ­Ø§Ù„Ø§Øª Ø®Ø§ØµØ©</div><div class="stat-change positive" id="orphanPercentage">0%</div></div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø© -->
    <div class="control-panel">
        <h2 class="panel-title">ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
        <div class="control-grid">
            <div class="control-group"><label class="control-label">Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label><input type="text" id="searchInput" class="control-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..."></div>
            <div class="control-group"><label class="control-label">Ø§Ù„ØµÙ</label><select id="filterGrade" class="control-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option><option value="Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·">Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·</option><option value="Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·">Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·</option><option value="Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·">Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·</option></select></div>
            <div class="control-group"><label class="control-label">Ø§Ù„Ø´Ø¹Ø¨Ø©</label><select id="filterSection" class="control-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø¹Ø¨</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
            <div class="control-group"><label class="control-label">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</label><select id="filterEconomic" class="control-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</option><option>Ù…Ø±ØªÙØ¹</option><option>Ù…ØªÙˆØ³Ø·</option><option>Ø¯ÙˆÙ† Ø§Ù„Ù…ØªÙˆØ³Ø·</option><option>Ù…Ù†Ø®ÙØ¶</option><option>Ø¶Ø¹ÙŠÙ</option></select></div>
            <div class="control-group"><label class="control-label">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§ØµØ©</label><select id="filterSpecial" class="control-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option><option>Ù…Ø­ØªØ§Ø¬ Ù…Ø§Ù„ÙŠØ§Ù‹</option><option>Ù…Ù† Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø©</option><option>Ù…ÙˆÙ‡ÙˆØ¨</option><option>ÙŠØªÙŠÙ…</option><option>Ù…Ø´Ø§ÙƒÙ„ Ù†ÙØ³ÙŠØ©</option><option>Ù…Ø´Ø§ÙƒÙ„ ØµØ­ÙŠØ©</option></select></div>
            <div class="control-group"><label class="control-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³ÙƒÙ†ÙŠØ©</label><select id="filterNeighborhood" class="control-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</option></select></div>
        </div>
        <div class="action-buttons">
            <button class="action-btn btn-primary" onclick="applyFilters()">ğŸ” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
            <button class="action-btn btn-secondary" onclick="clearFilters()">ğŸ”„ Ù…Ø³Ø­ Ø§Ù„ÙÙ„ØªØ±</button>
            <button class="action-btn btn-success" onclick="exportFilteredData()">ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
            <button class="action-btn btn-warning" onclick="generateReport()">ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</button>
            <button class="action-btn btn-info" onclick="refreshData()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="action-btn btn-danger" onclick="deleteFilteredStudents()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©</button>
            <button class="action-btn btn-danger" onclick="deleteAllStudents()">ğŸ’€ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
    </div>

    <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ± -->
    <div class="export-options">
        <h2 class="panel-title">ğŸ“¤ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
        <div class="export-grid">
            <div class="control-group"><label class="control-label">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label><select id="reportType" class="control-select"><option value="complete">ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</option><option value="economic">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ</option><option value="health">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµØ­ÙŠ</option><option value="health-diseases">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ ÙˆØ§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØµØ­ÙŠØ©</option><option value="social">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</option><option value="academic">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</option><option value="talents">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ù‡Ø¨ ÙˆØ§Ù„Ù‚Ø¯Ø±Ø§Øª</option><option value="attendance">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</option></select></div>
            <div class="control-group"><label class="control-label">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØµØ¯ÙŠØ±</label><select id="exportFormat" class="control-select"><option value="excel">Excel (.xlsx)</option><option value="pdf">PDF</option><option value="csv">CSV</option><option value="word">Word Document</option><option value="print">Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</option></select></div>
            <div class="control-group"><label class="control-label">ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label><select id="reportPeriod" class="control-select"><option value="current">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ</option><option value="semester1">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</option><option value="semester2">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option value="year">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„ÙƒØ§Ù…Ù„</option><option value="custom">ÙØªØ±Ø© Ù…Ø®ØµØµØ©</option></select></div>
        </div>
        <div class="action-buttons">
            <button class="action-btn btn-success" onclick="exportByGrade()">ğŸ“Š ØªØµØ¯ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„ØµÙ</button>
            <button class="action-btn btn-success" onclick="exportByEconomicStatus()">ğŸ’° ØªØµØ¯ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</button>
            <button class="action-btn btn-success" onclick="exportSpecialCases()">â­ ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø§ØµØ©</button>
            <!-- Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
            <button class="action-btn btn-success" onclick="exportHealthCases()">ğŸ¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©</button>
            <button class="action-btn btn-warning" onclick="exportContactList()">ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø§ØªØµØ§Ù„</button>
            <button class="action-btn btn-info" onclick="generateStatisticalReport()">ğŸ“ˆ ØªÙ‚Ø±ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠ</button>
        </div>
    </div>

    <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
    <div class="students-section">
        <div class="section-header">
            <h2 class="section-title">ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† <span id="studentsCount" style="font-size:16px;color:#718096;">(0 Ø·Ø§Ù„Ø¨)</span></h2>
            <div class="view-controls">
                <button class="view-btn active" id="gridViewBtn" onclick="switchView('grid')">Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ©</button>
                <button class="view-btn" id="listViewBtn" onclick="switchView('list')">Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                <select id="sortBy" class="control-select" style="width:auto;min-width:180px;">
                    <option value="name">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø§Ø³Ù… (Ø£-ÙŠ)</option><option value="grade">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„ØµÙ</option><option value="economic">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</option><option value="date">ØªØ±ØªÙŠØ¨ Ø¨ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</option><option value="status">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§ØµØ©</option>
                </select>
            </div>
        </div>
        <div class="students-grid active" id="studentsGrid"></div>
        <div class="students-list" id="studentsList"></div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2 class="modal-title" id="modalStudentName">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h2><button class="close-btn" onclick="closeModal()">&times;</button></div>
        <div class="modal-body" id="modalBody"></div>
        <div style="display:flex;gap:15px;justify-content:center;margin-top:30px;flex-wrap:wrap;"><button class="action-btn btn-primary" onclick="printStudentDetails()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button><button class="action-btn btn-secondary" onclick="editStudentFromModal()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button><button class="action-btn btn-warning" onclick="exportStudentData()">ğŸ’¾ ØªØµØ¯ÙŠØ± ÙƒÙ…Ù„Ù</button><button class="action-btn btn-info" onclick="sendNotification()">ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</button></div>
    </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyDMkhB9tjAnWHBJo3pa7LHRGTfjLRg0yB4",
    authDomain: "nawafalsubhi3-f4abf.firebaseapp.com",
    projectId: "nawafalsubhi3-f4abf",
    storageBucket: "nawafalsubhi3-f4abf.firebasestorage.app",
    messagingSenderId: "409217413356",
    appId: "1:409217413356:web:d1e0dd6f584c66255875c9",
    measurementId: "G-BVP04DLPM9"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© */
let studentsData = [];
let filteredData = [];
let currentView = 'grid';
let isConnected = true;

/* ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ===== */
function updateConnectionStatus(connected, msg = '') {
    const el = document.getElementById('connectionStatus');
    el.className = connected ? 'connection-status' : 'connection-status disconnected';
    el.innerHTML = (connected ? 'ğŸ”— Ù…ØªØµÙ„' : 'âŒ ØºÙŠØ± Ù…ØªØµÙ„') + (msg ? ' - ' + msg : '');
    isConnected = connected;
}
function updateLastRefreshTime() {
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ar-SA');
}

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===== */
async function loadStudentsFromFirebase() {
    try {
        updateConnectionStatus(true, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
        const q = query(collection(db, 'students_data'), orderBy('timestamp', 'desc'));
        const snap = await getDocs(q);
        studentsData = []; snap.forEach(d => studentsData.push({ id: d.id, ...d.data() }));
        updateConnectionStatus(true, `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${studentsData.length} Ø·Ø§Ù„Ø¨`);
        return { success: true };
    } catch (e) {
        updateConnectionStatus(false, 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„');
        return { success: false, error: e.message };
    }
}
function setupRealtimeListener() {
    const q = query(collection(db, 'students_data'), orderBy('timestamp', 'desc'));
    onSnapshot(q, snap => {
        studentsData = []; snap.forEach(d => studentsData.push({ id: d.id, ...d.data() }));
        updateStatistics(); populateNeighborhoodFilter();
        filteredData = [...studentsData]; renderStudents(); updateLastRefreshTime();
    }, err => { console.error(err); updateConnectionStatus(false, 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«'); });
}

/* ===== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ===== */
function updateStatistics() {
    const t = studentsData.length;
    animateNumber('totalStudents', t);
    animateNumber('studentsNeedHelp', studentsData.filter(s => s.financialNeed === 'Ù†Ø¹Ù…').length);
    animateNumber('studentsWithDisabilities', studentsData.filter(s => s.studentDisability === 'Ù†Ø¹Ù…').length);
    animateNumber('studentsWithTalents', studentsData.filter(s => s.hasTalents === 'Ù†Ø¹Ù…').length);
    animateNumber('studentsWithProblems', studentsData.filter(s => s.psychologicalProblems === 'Ù†Ø¹Ù…' || s.mentalHealth === 'Ù†Ø¹Ù…' || s.healthProblems === 'Ù†Ø¹Ù…' || s.healthConditions === 'Ù†Ø¹Ù…').length);
    animateNumber('orphanStudents', studentsData.filter(s => s.fatherStatus === 'Ù…ØªÙˆÙÙŠ' || s.motherStatus === 'Ù…ØªÙˆÙÙŠØ©').length);
    document.getElementById('needHelpPercentage').textContent = t ? `${Math.round(studentsData.filter(s => s.financialNeed === 'Ù†Ø¹Ù…').length / t * 100)}% Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹` : '0%';
    document.getElementById('disabilityPercentage').textContent = t ? `${Math.round(studentsData.filter(s => s.studentDisability === 'Ù†Ø¹Ù…').length / t * 100)}% Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹` : '0%';
    document.getElementById('talentsPercentage').textContent = t ? `${Math.round(studentsData.filter(s => s.hasTalents === 'Ù†Ø¹Ù…').length / t * 100)}% Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹` : '0%';
    document.getElementById('problemsPercentage').textContent = t ? `${Math.round(studentsData.filter(s => s.psychologicalProblems === 'Ù†Ø¹Ù…' || s.mentalHealth === 'Ù†Ø¹Ù…' || s.healthProblems === 'Ù†Ø¹Ù…' || s.healthConditions === 'Ù†Ø¹Ù…').length / t * 100)}% Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹` : '0%';
    document.getElementById('orphanPercentage').textContent = t ? `${Math.round(studentsData.filter(s => s.fatherStatus === 'Ù…ØªÙˆÙÙŠ' || s.motherStatus === 'Ù…ØªÙˆÙÙŠØ©').length / t * 100)}% Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹` : '0%';
}
function animateNumber(id, target) {
    const el = document.getElementById(id), start = parseInt(el.textContent) || 0, dur = 1000, st = Date.now();
    function upd() {
        const p = Math.min((Date.now() - st) / dur, 1);
        el.textContent = Math.round(start + (target - start) * p);
        if (p < 1) requestAnimationFrame(upd);
    }
    upd();
}

/* ===== ÙÙ„ØªØ±Ø© ===== */
function populateNeighborhoodFilter() {
    const nh = [...new Set(studentsData.map(s => s.neighborhood).filter(n => n))].sort();
    const sel = document.getElementById('filterNeighborhood');
    sel.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</option>';
    nh.forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.textContent = o; sel.appendChild(opt); });
}
window.applyFilters = () => {
    const src = studentsData.slice();
    const sTerm = document.getElementById('searchInput').value.trim().toLowerCase();
    const sGrade = document.getElementById('filterGrade').value;
    const sSec = document.getElementById('filterSection').value;
    const sEcon = document.getElementById('filterEconomic').value;
    const sSpec = document.getElementById('filterSpecial').value;
    const sNh = document.getElementById('filterNeighborhood').value;
    const sort = document.getElementById('sortBy').value;

    filteredData = src.filter(st =>
        (!sTerm || st.studentName.toLowerCase().includes(sTerm) || st.nationalId.includes(sTerm)) &&
        (!sGrade || st.grade === sGrade) &&
        (!sSec || st.section === sSec) &&
        (!sEcon || st.economicLevel === sEcon) &&
        (!sNh || st.neighborhood === sNh) &&
        (!sSpec || (function () {
            switch (sSpec) {
                case 'Ù…Ø­ØªØ§Ø¬ Ù…Ø§Ù„ÙŠØ§Ù‹': return st.financialNeed === 'Ù†Ø¹Ù…';
                case 'Ù…Ù† Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø©': return st.studentDisability === 'Ù†Ø¹Ù…';
                case 'Ù…ÙˆÙ‡ÙˆØ¨': return st.hasTalents === 'Ù†Ø¹Ù…';
                case 'ÙŠØªÙŠÙ…': return st.fatherStatus === 'Ù…ØªÙˆÙÙŠ' || st.motherStatus === 'Ù…ØªÙˆÙÙŠØ©';
                case 'Ù…Ø´Ø§ÙƒÙ„ Ù†ÙØ³ÙŠØ©': return st.psychologicalProblems === 'Ù†Ø¹Ù…' || st.mentalHealth === 'Ù†Ø¹Ù…';
                case 'Ù…Ø´Ø§ÙƒÙ„ ØµØ­ÙŠØ©': return st.healthProblems === 'Ù†Ø¹Ù…' || st.healthConditions === 'Ù†Ø¹Ù…';
                default: return true;
            }
        })())
    );
    filteredData.sort((a, b) => {
        switch (sort) {
            case 'name': return a.studentName.localeCompare(b.studentName, 'ar');
            case 'grade': const g = { 'Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·': 1, 'Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·': 2, 'Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·': 3 }; return (g[a.grade] || 0) - (g[b.grade] || 0);
            case 'economic': const e = { 'Ø¶Ø¹ÙŠÙ': 1, 'Ù…Ù†Ø®ÙØ¶': 2, 'Ø¯ÙˆÙ† Ø§Ù„Ù…ØªÙˆØ³Ø·': 3, 'Ù…ØªÙˆØ³Ø·': 4, 'Ù…Ø±ØªÙØ¹': 5 }; return (e[b.economicLevel] || 0) - (e[a.economicLevel] || 0);
            case 'date': return new Date(b.submittedAt || b.createdAt) - new Date(a.submittedAt || a.createdAt);
            case 'status': return getStudentPriority(b) - getStudentPriority(a);
            default: return 0;
        }
    });
    renderStudents();
};
window.clearFilters = () => {
    document.getElementById('searchInput').value = '';
    document.getElementById('filterGrade').value = '';
    document.getElementById('filterSection').value = '';
    document.getElementById('filterEconomic').value = '';
    document.getElementById('filterSpecial').value = '';
    document.getElementById('filterNeighborhood').value = '';
    document.getElementById('sortBy').value = 'name';
    filteredData = [...studentsData]; renderStudents();
};
function getStudentPriority(st) {
    let p = 0;
    if (st.financialNeed === 'Ù†Ø¹Ù…') p += 4;
    if (st.studentDisability === 'Ù†Ø¹Ù…') p += 3;
    if (st.fatherStatus === 'Ù…ØªÙˆÙÙŠ' || st.motherStatus === 'Ù…ØªÙˆÙÙŠØ©') p += 5;
    if (st.psychologicalProblems === 'Ù†Ø¹Ù…' || st.mentalHealth === 'Ù†Ø¹Ù…') p += 3;
    if (st.hasTalents === 'Ù†Ø¹Ù…') p += 2;
    return p;
}

/* ===== Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨ ===== */
window.switchView = v => {
    currentView = v;
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(v + 'ViewBtn').classList.add('active');
    document.getElementById('studentsGrid').classList.toggle('active', v === 'grid');
    document.getElementById('studentsList').classList.toggle('active', v === 'list');
    renderStudents();
};
function renderStudents() {
    const cnt = filteredData.length;
    document.getElementById('studentsCount').textContent = `(${cnt} Ø·Ø§Ù„Ø¨)`;
    if (!cnt) {
        const empty = `<div class="empty-state"><div class="empty-icon">ğŸ”</div><div class="empty-title">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</div><div class="empty-description">ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙ„Ø§ØªØ± Ø£Ùˆ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«</div></div>`;
        document.getElementById('studentsGrid').innerHTML = empty;
        document.getElementById('studentsList').innerHTML = empty;
        return;
    }
    currentView === 'grid' ? renderGridView() : renderListView();
}
function renderGridView() {
    const g = document.getElementById('studentsGrid');
    g.innerHTML = filteredData.map(st => {
        const s = getStudentStatus(st);
        return `
            <div class="student-card" onclick="viewStudentDetails('${st.id}')">
                <div class="student-header">
                    <div><div class="student-name">${st.studentName}</div><div class="student-id">Ù‡ÙˆÙŠØ©: ${st.nationalId}</div></div>
                    <div class="student-status ${s.class}">${s.text}</div>
                </div>
                <div class="student-info">
                    <div class="info-row"><span class="info-label">Ø§Ù„ØµÙ:</span><span class="info-value">${st.grade} - ${st.section}</span></div>
                    <div class="info-row"><span class="info-label">ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</span><span class="info-value">${st.guardianName}</span></div>
                    <div class="info-row"><span class="info-label">Ø§Ù„Ø¬ÙˆØ§Ù„:</span><span class="info-value">${st.guardianPhone}</span></div>
                    <div class="info-row"><span class="info-label">Ø§Ù„Ø­ÙŠ:</span><span class="info-value">${st.neighborhood || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span></div>
                    <div class="info-row"><span class="info-label">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©:</span><span class="info-value">${st.economicLevel || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span></div>
                    <div class="info-row"><span class="info-label">Ù…Ø­ØªØ§Ø¬ Ù…Ø§Ù„ÙŠØ§Ù‹:</span><span class="info-value">${st.financialNeed || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span></div>
                </div>
                <div class="student-actions" onclick="event.stopPropagation()">
                    <button class="student-btn btn-view" onclick="viewStudentDetails('${st.id}')">Ø¹Ø±Ø¶</button>
                    <button class="student-btn btn-edit" onclick="editStudent('${st.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="student-btn btn-delete" onclick="deleteStudent('${st.id}')">Ø­Ø°Ù</button>
                </div>
            </div>`;
    }).join('');
}
function renderListView() {
    const l = document.getElementById('studentsList');
    l.innerHTML = filteredData.map(st => {
        const s = getStudentStatus(st);
        const initials = st.studentName.split(' ').map(n => n[0]).join('').substring(0, 2);
        return `
            <div class="student-list-item" onclick="viewStudentDetails('${st.id}')">
                <div class="list-avatar">${initials}</div>
                <div class="list-info">
                    <div class="list-name">${st.studentName}</div>
                    <div class="list-details">${st.grade} - ${st.section} | ${st.guardianName} | ${st.guardianPhone}<br>${st.neighborhood || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} | ${st.economicLevel || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                </div>
                <div class="list-status"><span class="student-status ${s.class}">${s.text}</span></div>
                <div class="list-actions" onclick="event.stopPropagation()">
                    <button class="student-btn btn-view" onclick="viewStudentDetails('${st.id}')">Ø¹Ø±Ø¶</button>
                    <button class="student-btn btn-edit" onclick="editStudent('${st.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="student-btn btn-delete" onclick="deleteStudent('${st.id}')">Ø­Ø°Ù</button>
                </div>
            </div>`;
    }).join('');
}
function getStudentStatus(st) {
    if (st.fatherStatus === 'Ù…ØªÙˆÙÙŠ' || st.motherStatus === 'Ù…ØªÙˆÙÙŠØ©') return { class: 'status-needs-help', text: 'ÙŠØªÙŠÙ…' };
    if (st.financialNeed === 'Ù†Ø¹Ù…') return { class: 'status-needs-help', text: 'Ù…Ø­ØªØ§Ø¬' };
    if (st.studentDisability === 'Ù†Ø¹Ù…') return { class: 'status-disability', text: 'Ø¥Ø¹Ø§Ù‚Ø©' };
    if (st.psychologicalProblems === 'Ù†Ø¹Ù…' || st.mentalHealth === 'Ù†Ø¹Ù…') return { class: 'status-needs-help', text: 'Ù…ØªØ§Ø¨Ø¹Ø© Ù†ÙØ³ÙŠØ©' };
    if (st.healthConditions === 'Ù†Ø¹Ù…' || st.healthProblems === 'Ù†Ø¹Ù…') return { class: 'status-needs-help', text: 'Ù…ØªØ§Ø¨Ø¹Ø© ØµØ­ÙŠØ©' };
    if (st.hasTalents === 'Ù†Ø¹Ù…') return { class: 'status-talented', text: 'Ù…ÙˆÙ‡ÙˆØ¨' };
    return { class: 'status-normal', text: 'Ø¹Ø§Ø¯ÙŠ' };
}

/* ===== ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ ===== */
window.viewStudentDetails = id => {
    const st = studentsData.find(x => x.id === id); if (!st) return;
    document.getElementById('modalStudentName').textContent = st.studentName;
    document.getElementById('modalBody').innerHTML = `
        <div class="info-section"><div class="section-title-modal">ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div><div class="info-grid">
            <div class="info-row"><span class="info-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</span><span class="info-value">${st.studentName}</span></div>
            <div class="info-row"><span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©:</span><span class="info-value">${st.nationalId}</span></div>
            <div class="info-row"><span class="info-label">Ø§Ù„Ø¬Ù†Ø³ÙŠØ©:</span><span class="info-value">${st.nationality}</span></div>
            <div class="info-row"><span class="info-label">Ø§Ù„Ø¹Ù…Ø±:</span><span class="info-value">${st.age} Ø³Ù†Ø©</span></div>
            <div class="info-row"><span class="info-label">Ø§Ù„ØµÙ ÙˆØ§Ù„Ø´Ø¹Ø¨Ø©:</span><span class="info-value">${st.grade} - ${st.section}</span></div>
        </div></div>
        <div class="info-section"><div class="section-title-modal">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</div><div class="info-grid">
            <div class="info-row"><span class="info-label">Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</span><span class="info-value">${st.guardianName}</span></div>
            <div class="info-row"><span class="info-label">Ø¬ÙˆØ§Ù„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</span><span class="info-value">${st.guardianPhone}</span></div>
            <div class="info-row"><span class="info-label">Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…Ù„:</span><span class="info-value">${st.workPhone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span></div>
            <div class="info-row"><span class="info-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…Ù„:</span><span class="info-value">${st.workAddress || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span></div>
        </div></div>
        <div class="info-section"><div class="section-title-modal">ğŸ’° Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</div><div class="info-grid">
            <div class="info-row"><span class="info-label">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø³Ø±Ø©:</span><span class="info-value">${st.economicLevel}</span></div>
            <div class="info-row"><span class="info-label">Ù…ØµØ¯Ø± Ø§Ù„Ø¯Ø®Ù„:</span><span class="info-value">${st.incomeSource}</span></div>
            <div class="info-row"><span class="info-label">Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ:</span><span class="info-value">${st.monthlyIncome}</span></div>
            <div class="info-row"><span class="info-label">Ù…Ø­ØªØ§Ø¬ Ù…Ø§Ù„ÙŠØ§Ù‹:</span><span class="info-value">${st.financialNeed}</span></div>
            <div class="info-row"><span class="info-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„ÙŠÙ†:</span><span class="info-value">${st.dependentsCount}</span></div>
        </div></div>
        <div class="info-section"><div class="section-title-modal">ğŸ  Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</div><div class="info-grid">
            <div class="info-row"><span class="info-label">Ø§Ù„Ø­ÙŠ:</span><span class="info-value">${st.neighborhood}</span></div>
            <div class="info-row"><span class="info-label">Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</span><span class="info-value">${st.distanceFromSchool} ÙƒÙ…</span></div>
            <div class="info-row"><span class="info-label">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙƒÙ†:</span><span class="info-value">${st.housingType} - ${st.buildingType}</span></div>
            <div class="info-row"><span class="info-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¨:</span><span class="info-value">${st.fatherStatus}</span></div>
            <div class="info-row"><span class="info-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù…:</span><span class="info-value">${st.motherStatus}</span></div>
            <div class="info-row"><span class="info-label">ÙŠØ¹ÙŠØ´ Ù…Ø¹:</span><span class="info-value">${st.livesWith}</span></div>
        </div></div>
        <div class="info-section"><div class="section-title-modal">ğŸ¥¼ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ­ÙŠØ©</div><div class="info-grid">
            <div class="info-row"><span class="info-label">Ù…Ø´Ø§ÙƒÙ„ ØµØ­ÙŠØ©:</span><span class="info-value">${st.healthConditions}</span></div>
            <div class="info-row"><span class="info-label">Ø¹Ù…Ù„ÙŠØ§Øª Ø¬Ø±Ø§Ø­ÙŠØ©:</span><span class="info-value">${st.surgeries}</span></div>
            <div class="info-row"><span class="info-label">Ù…Ø´Ø§ÙƒÙ„ Ù†ÙØ³ÙŠØ©:</span><span class="info-value">${st.mentalHealth}</span></div>
            <div class="info-row"><span class="info-label">Ù…Ù† Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø©:</span><span class="info-value">${st.studentDisability}</span></div>
        </div></div>
        <div class="info-section"><div class="section-title-modal">ğŸŒŸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</div><div class="info-grid">
            <div class="info-row"><span class="info-label">Ù„Ø¯ÙŠÙ‡ Ù…ÙˆØ§Ù‡Ø¨:</span><span class="info-value">${st.hasTalents}</span></div>
            ${st.talentsDetails ? `<div class="info-row"><span class="info-label">Ø§Ù„Ù…ÙˆØ§Ù‡Ø¨:</span><span class="info-value">${st.talentsDetails}</span></div>` : ''}
            ${st.additionalNotes ? `<div class="info-row"><span class="info-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span><span class="info-value">${st.additionalNotes}</span></div>` : ''}
            <div class="info-row"><span class="info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</span><span class="info-value">${st.submittedAt || st.createdAt}</span></div>
        </div></div>`;
    document.getElementById('studentModal').style.display = 'block';
};
window.closeModal = () => document.getElementById('studentModal').style.display = 'none';
window.onclick = e => { if (e.target === document.getElementById('studentModal')) closeModal(); };

/* ===== Ø­Ø°Ù ===== */
window.deleteStudent = async id => {
    const st = studentsData.find(x => x.id === id); if (!st) return;
    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨: ${st.studentName}ØŸ`)) {
        try { await deleteDoc(doc(db, 'students_data', id)); alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù'); } catch (e) { alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + e.message); }
    }
};
window.deleteFilteredStudents = async () => {
    if (!filteredData.length) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙÙ„ØªØ±Ø©'); return; }
    if (!confirm(`Ø³ÙŠØªÙ… Ø­Ø°Ù ${filteredData.length} Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ÙÙ„ØªØ±Ø© ÙÙ‚Ø·ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) return;
    try { await Promise.all(filteredData.map(st => deleteDoc(doc(db, 'students_data', st.id)))); alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©'); await refreshData(); } catch (e) { alert('âŒ Ø®Ø·Ø£: ' + e.message); }
};
window.deleteAllStudents = async () => {
    if (!confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
    const p = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ØªØ£ÙƒÙŠØ¯ (counselor123):');
    if (p !== 'counselor123') return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
    try {
        const snap = await getDocs(collection(db, 'students_data'));
        await Promise.all(snap.docs.map(d => deleteDoc(doc(db, 'students_data', d.id))));
        alert('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); await refreshData();
    } catch (e) { alert('âŒ Ø®Ø·Ø£: ' + e.message); }
};

/* ===== ØªØµØ¯ÙŠØ± ===== */
function exportToCSV(data, filename) {
    if (!data.length) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
    const headers = Object.keys(data[0]);
    let csv = '\ufeff' + headers.join(',') + '\n';
    data.forEach(row => {
        const values = headers.map(h => {
            let v = row[h] || ''; v = String(v);
            if (v.includes(',') || v.includes('"') || v.includes('\n')) v = '"' + v.replace(/"/g, '""') + '"';
            return v;
        });
        csv += values.join(',') + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename + '.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
window.exportFilteredData = () => {
    const fmt = document.getElementById('exportFormat').value;
    const rep = document.getElementById('reportType').value;
    if (!filteredData.length) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
    if (fmt === 'csv' || fmt === 'excel') exportToCSV(filteredData, `ØªÙ‚Ø±ÙŠØ±_${rep}_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}`);
    else if (fmt === 'print') printReport(filteredData, rep);
    else alert('PDF / Word Ù‚Ø±ÙŠØ¨Ø§Ù‹');
};
window.exportByGrade = () => ['Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·', 'Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·', 'Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·'].forEach(g => {
    const dt = studentsData.filter(s => s.grade === g); if (dt.length) exportToCSV(dt, `Ø·Ù„Ø§Ø¨_${g.replace(' ', '_')}_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}`);
});
window.exportByEconomicStatus = () => ['Ø¶Ø¹ÙŠÙ', 'Ù…Ù†Ø®ÙØ¶', 'Ø¯ÙˆÙ† Ø§Ù„Ù…ØªÙˆØ³Ø·', 'Ù…ØªÙˆØ³Ø·', 'Ù…Ø±ØªÙØ¹'].forEach(l => {
    const dt = studentsData.filter(s => s.economicLevel === l); if (dt.length) exportToCSV(dt, `Ù…Ø³ØªÙˆÙ‰_${l}_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}`);
});
window.exportSpecialCases = () => {
    const sp = {
        'Ù…Ø­ØªØ§Ø¬ÙˆÙ†_Ù…Ø§Ù„ÙŠØ§Ù‹': studentsData.filter(s => s.financialNeed === 'Ù†Ø¹Ù…'),
        'Ø°ÙˆÙˆ_Ø§Ø¹Ø§Ù‚Ø©': studentsData.filter(s => s.studentDisability === 'Ù†Ø¹Ù…'),
        'Ù…ÙˆÙ‡ÙˆØ¨ÙˆÙ†': studentsData.filter(s => s.hasTalents === 'Ù†Ø¹Ù…'),
        'Ø§ÙŠØªØ§Ù…': studentsData.filter(s => s.fatherStatus === 'Ù…ØªÙˆÙÙŠ' || s.motherStatus === 'Ù…ØªÙˆÙÙŠØ©'),
        'Ø­Ø§Ù„Ø§Øª_Ø®Ø§ØµØ©': studentsData.filter(s => s.psychologicalProblems === 'Ù†Ø¹Ù…' || s.mentalHealth === 'Ù†Ø¹Ù…' || s.healthProblems === 'Ù†Ø¹Ù…' || s.healthConditions === 'Ù†Ø¹Ù…')
    };
    Object.entries(sp).forEach(([k, d]) => { if (d.length) exportToCSV(d, `${k}_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}`); });
};
window.exportContactList = () => {
    const dt = studentsData.map(s => ({ 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': s.studentName, 'Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±': s.guardianName, 'Ø¬ÙˆØ§Ù„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±': s.guardianPhone, 'Ø¬ÙˆØ§Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨': s.studentPhone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±', 'Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…Ù„': s.workPhone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±', 'Ø§Ù„ØµÙ': s.grade, 'Ø§Ù„Ø´Ø¹Ø¨Ø©': s.section, 'Ø§Ù„Ø­ÙŠ': s.neighborhood || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }));
    exportToCSV(dt, `Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ø§ØªØµØ§Ù„_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}`);
};
window.generateStatisticalReport = () => {
    const stats = generateDetailedStatistics();
    exportToCSV([stats], `Ø§Ù„ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø§Ø­ØµØ§Ø¦ÙŠ_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}`);
};

/* === ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ø¨Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙ‚Ø· === */
window.exportHealthCases = () => {
    const src = filteredData.length ? filteredData : studentsData;
    if (!src.length) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ©'); return; }

    // Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯Ù‡Ø§ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙÙ‚Ø·
    const columns = [
        { header: 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨',           key: 'studentName' },
        { header: 'Ø§Ù„ØµÙ',                 key: 'grade' },
        { header: 'Ø§Ù„Ø´Ø¹Ø¨Ø©',               key: 'section' },
        { header: 'Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±',        key: 'guardianName' },
        { header: 'Ø¬ÙˆØ§Ù„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±',       key: 'guardianPhone' },
        { header: 'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©',       key: 'healthDetails' } // Ø³ÙØªØ­Ø³Ø¨ Ù„Ø§Ø­Ù‚Ø§Ù‹
    ];

    const rows = [columns.map(c => c.header)]; // header row
    let found = 0;

    src.forEach(st => {
        const problems = [];
        if (st.healthProblems === 'Ù†Ø¹Ù…' && st.healthProblemsDetails) problems.push(st.healthProblemsDetails);
        if (st.healthConditions === 'Ù†Ø¹Ù…' && st.healthConditionsDetails) problems.push(st.healthConditionsDetails);
        if (st.mentalHealth === 'Ù†Ø¹Ù…' && st.mentalHealthDetails) problems.push(st.mentalHealthDetails);
        if (!problems.length) return; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ ÙŠÙØµØ¯Ø±

        found++;
        const row = columns.map(c => {
            if (c.key === 'healthDetails') return problems.join(' + ');
            return st[c.key] || '';
        });
        rows.push(row);
    });

    if (!found) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ù…Ø±Ø¶ÙŠØ© ÙÙ‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠØ©'); return; }

    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©');
    XLSX.writeFile(wb, `Ø§Ù„Ø­Ø§Ù„Ø§Øª_Ø§Ù„Ù…Ø±Ø¶ÙŠØ©_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xlsx`);
};

/* ===== Ø·Ø¨Ø§Ø¹Ø© ===== */
window.printStudentDetails = () => {
    const name = document.getElementById('modalStudentName').textContent;
    const content = document.getElementById('modalBody').innerHTML;
    const win = window.open('', '_blank');
    win.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ - ${name}</title>
        <style>body{font-family:'Cairo',Arial,sans-serif;margin:20px;direction:rtl;line-height:1.6}.header{text-align:center;margin-bottom:30px;border-bottom:3px solid #0d5c0d;padding-bottom:20px}.info-section{margin-bottom:25px;padding:20px;border:2px solid #e2e8f0;border-radius:10px;background:#f8f9fa}.section-title-modal{font-size:18px;font-weight:bold;color:#0d5c0d;margin-bottom:15px;border-bottom:2px solid #0d5c0d;padding-bottom:5px}.info-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e2e8f0}.info-label{font-weight:bold;color:#4a5568;width:40%}.info-value{color:#2d3748;width:60%;text-align:left}@media print{body{margin:0}.info-section{break-inside:avoid}}</style>
        </head><body>
        <div class="header"><h1>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨: ${name}</h1><p>Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ - Ù…ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹ÙˆØ§Ù„ÙŠ</p><p>Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ: Ù…Ø­Ù…Ø¯ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ</p><p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleDateString('ar-SA')}</p></div>
        ${content}
        <div style="text-align:center;margin-top:30px;color:#666;font-size:12px;"><p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</p></div>
        </body></html>`);
    win.document.close(); win.print();
};
window.printReport = (data, reportType) => {
    const win = window.open('', '_blank');
    win.document.write(generatePrintContent(data, reportType));
    win.document.close(); win.print();
};
function generatePrintContent(data, reportType) {
    const stats = generateDetailedStatistics();
    return `<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>ØªÙ‚Ø±ÙŠØ± ${reportType} - Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</title>
        <style>body{font-family:'Cairo',Arial,sans-serif;margin:20px;direction:rtl;line-height:1.6}.header{text-align:center;margin-bottom:30px;border-bottom:3px solid #0d5c0d;padding-bottom:20px}.logo{font-size:24px;color:#0d5c0d;margin-bottom:10px}.title{font-size:24px;font-weight:bold;margin-bottom:8px}.subtitle{font-size:16px;color:#666;margin-bottom:5px}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:30px 0}.stat-item{text-align:center;padding:15px;border:2px solid #0d5c0d;border-radius:10px}.stat-number{font-size:28px;font-weight:bold;color:#0d5c0d}.stat-label{font-size:14px;color:#666;margin-top:5px}table{width:100%;border-collapse:collapse;margin-top:20px;font-size:12px}th,td{border:1px solid #ddd;padding:8px;text-align:right}th{background:#f8f9fa;font-weight:bold;color:#0d5c0d}@media print{body{margin:0}}</style>
    </head><body>
    <div class="header"><div class="logo">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div><div class="title">Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</div><div class="subtitle">Ù…ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹ÙˆØ§Ù„ÙŠ - ØªÙ‚Ø±ÙŠØ± ${reportType}</div><div class="subtitle">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯: ${new Date().toLocaleDateString('ar-SA')}</div><div class="subtitle">Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ: Ù…Ø­Ù…Ø¯ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ</div></div>
    <div class="stats-grid">
        <div class="stat-item"><div class="stat-number">${stats['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨']}</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div></div>
        <div class="stat-item"><div class="stat-number">${stats['Ø·Ù„Ø§Ø¨ Ù…Ø­ØªØ§Ø¬ÙˆÙ† Ù…Ø§Ù„ÙŠØ§Ù‹']}</div><div class="stat-label">Ù…Ø­ØªØ§Ø¬ÙˆÙ† Ù…Ø§Ù„ÙŠØ§Ù‹</div></div>
        <div class="stat-item"><div class="stat-number">${stats['Ø·Ù„Ø§Ø¨ Ø°ÙˆÙˆ Ø¥Ø¹Ø§Ù‚Ø©']}</div><div class="stat-label">Ø°ÙˆÙˆ Ø¥Ø¹Ø§Ù‚Ø©</div></div>
        <div class="stat-item"><div class="stat-number">${stats['Ø·Ù„Ø§Ø¨ Ù…ÙˆÙ‡ÙˆØ¨ÙˆÙ†']}</div><div class="stat-label">Ù…ÙˆÙ‡ÙˆØ¨ÙˆÙ†</div></div>
        <div class="stat-item"><div class="stat-number">${stats['Ø£ÙŠØªØ§Ù…']}</div><div class="stat-label">Ø£ÙŠØªØ§Ù…</div></div>
        <div class="stat-item"><div class="stat-number">${stats['Ù…Ø´Ø§ÙƒÙ„ Ù†ÙØ³ÙŠØ©']}</div><div class="stat-label">Ù…Ø´Ø§ÙƒÙ„ Ù†ÙØ³ÙŠØ©</div></div>
    </div>
    <table><thead><tr>
        <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th><th>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</th><th>Ù…Ø­ØªØ§Ø¬ Ù…Ø§Ù„ÙŠØ§Ù‹</th><th>Ø§Ù„Ø­ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§ØµØ©</th>
    </tr></thead><tbody>
    ${data.map(st => `<tr>
        <td>${st.studentName}</td><td>${st.nationalId}</td><td>${st.grade}</td><td>${st.section}</td>
        <td>${st.guardianName}</td><td>${st.guardianPhone}</td><td>${st.economicLevel || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
        <td>${st.financialNeed || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td><td>${st.neighborhood || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td><td>${getStudentStatus(st).text}</td>
    </tr>`).join('')}
    </tbody></table>
    <div style="text-align:center;margin-top:50px;color:#666;"><p>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</p><p style="font-size:12px;">ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ - ØªØ·ÙˆÙŠØ± Ù†ÙˆØ§Ù Ø§Ù„ØµØ¨Ø­ÙŠ</p></div>
    </body></html>`;
}
};

/* ===== Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ===== */
window.refreshData = async () => {
    document.getElementById('refreshIndicator').classList.add('loading');
    const r = await loadStudentsFromFirebase(); 
    if (r.success) { applyFilters(); updateConnectionStatus(true, 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­'); }
    else updateConnectionStatus(false, 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + r.error);
    document.getElementById('refreshIndicator').classList.remove('loading');
    updateLastRefreshTime();
};

window.editStudent = window.editStudentFromModal = window.exportStudentData = window.sendNotification = () => alert('Ø§Ù„Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± ÙˆØ³ØªÙƒÙˆÙ† Ù…ØªÙˆÙØ±Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹');

/* ===== Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ===== */
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeModal();
    if (e.ctrlKey && e.key === 'f') { e.preventDefault(); document.getElementById('searchInput').focus(); document.getElementById('searchInput').select(); }
    if (e.ctrlKey && e.key === 'r') { e.preventDefault(); refreshData(); }
    if (e.ctrlKey && e.key === 'e') { e.preventDefault(); exportFilteredData(); }
});

/* ===== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ===== */
document.addEventListener('DOMContentLoaded', async () => {
    showLoading(true);
    await loadDashboard();
    setupEventListeners();
    setupRealtimeListener();
    showLoading(false);
});

async function loadDashboard() {
    const r = await loadStudentsFromFirebase();
    if (r.success) { updateStatistics(); populateNeighborhoodFilter(); filteredData = [...studentsData]; renderStudents(); }
    else showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + r.error);
}
function setupEventListeners() {
    let t; document.getElementById('searchInput').addEventListener('input', () => { clearTimeout(t); t = setTimeout(applyFilters, 300); });
    ['filterGrade', 'filterSection', 'filterEconomic', 'filterSpecial', 'filterNeighborhood', 'sortBy'].forEach(id => document.getElementById(id).addEventListener('change', applyFilters));
}
function showLoading(show) {
    const g = document.getElementById('studentsGrid'), l = document.getElementById('studentsList');
    const html = `<div class="loading"><div style="text-align:center;"><div style="font-size:48px;margin-bottom:20px;">â³</div><div style="font-size:20px;margin-bottom:15px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div><div class="spinner"></div></div></div>`;
    if (show) { g.innerHTML = l.innerHTML = html; g.style.gridColumn = '1/-1'; document.getElementById('refreshIndicator').classList.add('loading'); }
    else { g.style.gridColumn = ''; document.getElementById('refreshIndicator').classList.remove('loading'); }
}
function showError(msg) {
    const html = `<div class="empty-state"><div class="empty-icon">âŒ</div><div class="empty-title">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</div><div class="empty-description">${msg}</div><div style="margin-top:20px;"><button onclick="refreshData()" class="action-btn btn-primary">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button></div></div>`;
    document.getElementById('studentsGrid').innerHTML = html;
    document.getElementById('studentsList').innerHTML = html;
}

console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„Ø© Ù…Ø¹ ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© (Ø£Ø¹Ù…Ø¯Ø© Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·)');
</script>
</body>
</html>
