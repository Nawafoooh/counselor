â€¦
                        <div class="info-row">
                            <span class="info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</span>
                            <span class="info-value">${student.submittedAt || student.createdAt}</span>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('studentModal').style.display = 'block';
        }

        window.closeModal = function() {
            document.getElementById('studentModal').style.display = 'none';
        }

        /* ========== ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©) ========== */
        window.exportHealthCases = function () {
            const src = filteredData.length ? filteredData : studentsData;
            if (!src.length) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ©'); return; }

            const columns = [
                { header: 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨',     key: 'studentName' },
                { header: 'Ø§Ù„ØµÙ',           key: 'grade' },
                { header: 'Ø§Ù„Ø´Ø¹Ø¨Ø©',         key: 'section' },
                { header: 'Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±',  key: 'guardianName' },
                { header: 'Ø¬ÙˆØ§Ù„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±', key: 'guardianPhone' },
                { header: 'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©', key: 'healthDetails' }
            ];

            const rows = [columns.map(c => c.header)];
            let found = 0;

            src.forEach(st => {
                const problems = [];
                if (st.healthProblems   === 'Ù†Ø¹Ù…' && st.healthProblemsDetails)   problems.push(st.healthProblemsDetails);
                if (st.healthConditions === 'Ù†Ø¹Ù…' && st.healthConditionsDetails) problems.push(st.healthConditionsDetails);
                if (st.mentalHealth     === 'Ù†Ø¹Ù…' && st.mentalHealthDetails)     problems.push(st.mentalHealthDetails);

                if (!problems.length) return;

                found++;
                const row = columns.map(c => {
                    if (c.key === 'healthDetails') return problems.join(' + ');
                    return st[c.key] || '';
                });
                rows.push(row);
            });

            if (!found) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ù…Ø±Ø¶ÙŠØ© ÙÙ‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠØ©'); return; }

            const ws = XLSX.utils.aoa_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©');
            XLSX.writeFile(wb, `Ø§Ù„Ø­Ø§Ù„Ø§Øª_Ø§Ù„Ù…Ø±Ø¶ÙŠØ©_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xlsx`);
        };

        // Ø¨Ø§Ù‚ÙŠ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø®Ø±Ù‰
        window.exportFilteredData = function() { /* â€¦ */ };
        window.exportByGrade        = function() { /* â€¦ */ };
        window.exportByEconomicStatus=function() { /* â€¦ */ };
        window.exportSpecialCases   = function() { /* â€¦ */ };
        window.exportContactList    = function() { /* â€¦ */ };
        window.generateStatisticalReport=function(){ /* â€¦ */ };

        function generateDetailedStatistics() { /* â€¦ */ }

        function exportToCSV(data, filename) {
            if (data.length === 0) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
            let csv = '\uFEFF';
            csv += Object.keys(data[0]).join(',') + '\n';
            data.forEach(row => {
                csv += Object.values(row).map(v => {
                    const str = String(v || '');
                    return (str.includes(',') || str.includes('"') || str.includes('\n'))
                        ? '"' + str.replace(/"/g, '""') + '"'
                        : str;
                }).join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename + '.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.exportToPDF = function(data, reportType) {
            alert('Ù…ÙŠØ²Ø© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ù€ PDF Ø³ØªÙƒÙˆÙ† Ù…ØªÙˆÙØ±Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹');
        };

        window.printReport = function(data, reportType) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(generatePrintContent(data, reportType));
            printWindow.document.close();
            printWindow.print();
        };

        function generatePrintContent(data, reportType) {
            const stats = generateDetailedStatistics();
            return `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªÙ‚Ø±ÙŠØ± ${reportType} - Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</title>
    <style>
        body{font-family:'Cairo',Arial,sans-serif;margin:20px;direction:rtl;line-height:1.6}
        .header{text-align:center;margin-bottom:30px;border-bottom:3px solid #0d5c0d;padding-bottom:20px}
        .logo{font-size:24px;color:#0d5c0d;margin-bottom:10px}
        .title{font-size:24px;font-weight:bold;margin-bottom:8px}
        .subtitle{font-size:16px;color:#666;margin-bottom:5px}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:30px 0}
        .stat-item{text-align:center;padding:15px;border:2px solid #0d5c0d;border-radius:10px}
        .stat-number{font-size:28px;font-weight:bold;color:#0d5c0d}
        .stat-label{font-size:14px;color:#666;margin-top:5px}
        table{width:100%;border-collapse:collapse;margin-top:20px;font-size:12px}
        th,td{border:1px solid #ddd;padding:8px;text-align:right}
        th{background-color:#f8f9fa;font-weight:bold;color:#0d5c0d}
        .page-break{page-break-before:always}
        @media print{body{margin:0}.no-print{display:none}}
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
        <div class="title">Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</div>
        <div class="subtitle">Ù…ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹ÙˆØ§Ù„ÙŠ - ØªÙ‚Ø±ÙŠØ± ${reportType}</div>
        <div class="subtitle">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯: ${new Date().toLocaleDateString('ar-SA')}</div>
        <div class="subtitle">Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ: Ù…Ø­Ù…Ø¯ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ</div>
    </div>

    <div class="stats-grid">
        <div class="stat-item"><div class="stat-number">${stats['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨']}</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div></div>
        <div class="stat-item"><div class="stat-number">${stats['Ø·Ù„Ø§Ø¨ Ù…Ø­ØªØ§Ø¬ÙˆÙ† Ù…Ø§Ù„ÙŠØ§Ù‹']}</div><div class="stat-label">Ù…Ø­ØªØ§Ø¬ÙˆÙ† Ù…Ø§Ù„ÙŠØ§Ù‹</div></div>
        <div class="stat-item"><div class="stat-number">${stats['Ø·Ù„Ø§Ø¨ Ø°ÙˆÙˆ Ø¥Ø¹Ø§Ù‚Ø©']}</div><div class="stat-label">Ø°ÙˆÙˆ Ø¥Ø¹Ø§Ù‚Ø©</div></div>
        <div class="stat-item"><div class="stat-number">${stats['Ø·Ù„Ø§Ø¨ Ù…ÙˆÙ‡ÙˆØ¨ÙˆÙ†']}</div><div class="stat-label">Ù…ÙˆÙ‡ÙˆØ¨ÙˆÙ†</div></div>
        <div class="stat-item"><div class="stat-number">${stats['Ø£ÙŠØªØ§Ù…']}</div><div class="stat-label">Ø£ÙŠØªØ§Ù…</div></div>
        <div class="stat-item"><div class="stat-number">${stats['Ù…Ø´Ø§ÙƒÙ„ Ù†ÙØ³ÙŠØ©']}</div><div class="stat-label">Ù…Ø´Ø§ÙƒÙ„ Ù†ÙØ³ÙŠØ©</div></div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                <th>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</th>
                <th>Ù…Ø­ØªØ§Ø¬ Ù…Ø§Ù„ÙŠØ§Ù‹</th><th>Ø§Ù„Ø­ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§ØµØ©</th>
            </tr>
        </thead>
        <tbody>
            ${data.map(student => `
                <tr>
                    <td>${student.studentName}</td>
                    <td>${student.nationalId}</td>
                    <td>${student.grade}</td>
                    <td>${student.section}</td>
                    <td>${student.guardianName}</td>
                    <td>${student.guardianPhone}</td>
                    <td>${student.economicLevel || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td>${student.financialNeed || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td>${student.neighborhood || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td>${getStudentStatus(student).text}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>

    <div class="page-break"></div>
    <div style="text-align:center;margin-top:50px;color:#666">
        <p>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</p>
        <p style="font-size:12px">ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ - ØªØ·ÙˆÙŠØ± Ù†ÙˆØ§Ù Ø§Ù„ØµØ¨Ø­ÙŠ</p>
    </div>
</body>
</html>`;
        }

        // Ø¨Ø§Ù‚ÙŠ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        function generateHealthDiseasesReport() { /* â€¦ */ }
        function generateEconomicReport()        { /* â€¦ */ }
        function generateHealthReport()          { /* â€¦ */ }
        function generateSocialReport()          { /* â€¦ */ }
        function generateTalentsReport()         { /* â€¦ */ }
        function generateAcademicReport()        { /* â€¦ */ }
        function generateCompleteReport()        { /* â€¦ */ }
        function showReportModal(reportData, reportType) { /* â€¦ */ }

        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        window.editStudent             = function(id) { alert('Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± â€¦'); };
        window.printStudentDetails     = function()   { /* â€¦ */ };
        window.editStudentFromModal    = function()   { alert('Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± â€¦'); };
        window.exportStudentData       = function()   { /* â€¦ */ };
        window.sendNotification        = function()   { alert('Ù…ÙŠØ²Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³ØªÙƒÙˆÙ† Ù…ØªÙˆÙØ±Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹ â€¦'); };
        window.closeModal              = function()   { document.getElementById('studentModal').style.display = 'none'; };

        // Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ + Ø­ÙØ¸ Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª + Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ + Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeModal();
            if (e.ctrlKey && e.key === 'f') { e.preventDefault(); document.getElementById('searchInput').focus(); document.getElementById('searchInput').select(); }
            if (e.ctrlKey && e.key === 'r') { e.preventDefault(); refreshData(); }
            if (e.ctrlKey && e.key === 'e') { e.preventDefault(); exportFilteredData(); }
        });

        function saveSearchPreferences() { /* â€¦ */ }
        function loadSearchPreferences() { /* â€¦ */ }
        function addTooltips()           { /* â€¦ */ }

        // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard().then(() => {
                setupEventListeners();
                loadSearchPreferences();
                addTooltips();
            });
        });

        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù…Ø¹ ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©');
    </script>
</body>
</html>
