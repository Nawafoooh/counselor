…
                        <div class="info-row">
                            <span class="info-label">تاريخ التسجيل:</span>
                            <span class="info-value">${student.submittedAt || student.createdAt}</span>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('studentModal').style.display = 'block';
        }

        window.closeModal = function() {
            document.getElementById('studentModal').style.display = 'none';
        }

        /* ========== تصدير الحالات المرضية (النسخة النهائية) ========== */
        window.exportHealthCases = function () {
            const src = filteredData.length ? filteredData : studentsData;
            if (!src.length) { alert('لا توجد بيانات حالية'); return; }

            const columns = [
                { header: 'اسم الطالب',     key: 'studentName' },
                { header: 'الصف',           key: 'grade' },
                { header: 'الشعبة',         key: 'section' },
                { header: 'اسم ولي الأمر',  key: 'guardianName' },
                { header: 'جوال ولي الأمر', key: 'guardianPhone' },
                { header: 'الحالة المرضية', key: 'healthDetails' }
            ];

            const rows = [columns.map(c => c.header)];
            let found = 0;

            src.forEach(st => {
                const problems = [];
                if (st.healthProblems   === 'نعم' && st.healthProblemsDetails)   problems.push(st.healthProblemsDetails);
                if (st.healthConditions === 'نعم' && st.healthConditionsDetails) problems.push(st.healthConditionsDetails);
                if (st.mentalHealth     === 'نعم' && st.mentalHealthDetails)     problems.push(st.mentalHealthDetails);

                if (!problems.length) return;

                found++;
                const row = columns.map(c => {
                    if (c.key === 'healthDetails') return problems.join(' + ');
                    return st[c.key] || '';
                });
                rows.push(row);
            });

            if (!found) { alert('لا توجد حالات مرضية فى النتائج الحالية'); return; }

            const ws = XLSX.utils.aoa_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'الحالات المرضية');
            XLSX.writeFile(wb, `الحالات_المرضية_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xlsx`);
        };

        // باقي دوال التصدير الأخرى
        window.exportFilteredData = function() { /* … */ };
        window.exportByGrade        = function() { /* … */ };
        window.exportByEconomicStatus=function() { /* … */ };
        window.exportSpecialCases   = function() { /* … */ };
        window.exportContactList    = function() { /* … */ };
        window.generateStatisticalReport=function(){ /* … */ };

        function generateDetailedStatistics() { /* … */ }

        function exportToCSV(data, filename) {
            if (data.length === 0) { alert('لا توجد بيانات للتصدير'); return; }
            let csv = '\uFEFF';
            csv += Object.keys(data[0]).join(',') + '\n';
            data.forEach(row => {
                csv += Object.values(row).map(v => {
                    const str = String(v || '');
                    return (str.includes(',') || str.includes('"') || str.includes('\n'))
                        ? '"' + str.replace(/"/g, '""') + '"'
                        : str;
                }).join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename + '.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.exportToPDF = function(data, reportType) {
            alert('ميزة التصدير لـ PDF ستكون متوفرة قريباً');
        };

        window.printReport = function(data, reportType) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(generatePrintContent(data, reportType));
            printWindow.document.close();
            printWindow.print();
        };

        function generatePrintContent(data, reportType) {
            const stats = generateDetailedStatistics();
            return `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تقرير ${reportType} - متوسطة المنذر بن عمرو الأنصاري</title>
    <style>
        body{font-family:'Cairo',Arial,sans-serif;margin:20px;direction:rtl;line-height:1.6}
        .header{text-align:center;margin-bottom:30px;border-bottom:3px solid #0d5c0d;padding-bottom:20px}
        .logo{font-size:24px;color:#0d5c0d;margin-bottom:10px}
        .title{font-size:24px;font-weight:bold;margin-bottom:8px}
        .subtitle{font-size:16px;color:#666;margin-bottom:5px}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:30px 0}
        .stat-item{text-align:center;padding:15px;border:2px solid #0d5c0d;border-radius:10px}
        .stat-number{font-size:28px;font-weight:bold;color:#0d5c0d}
        .stat-label{font-size:14px;color:#666;margin-top:5px}
        table{width:100%;border-collapse:collapse;margin-top:20px;font-size:12px}
        th,td{border:1px solid #ddd;padding:8px;text-align:right}
        th{background-color:#f8f9fa;font-weight:bold;color:#0d5c0d}
        .page-break{page-break-before:always}
        @media print{body{margin:0}.no-print{display:none}}
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">🇸🇦 المملكة العربية السعودية</div>
        <div class="title">متوسطة المنذر بن عمرو الأنصاري</div>
        <div class="subtitle">مكتب تعليم العوالي - تقرير ${reportType}</div>
        <div class="subtitle">تاريخ الإعداد: ${new Date().toLocaleDateString('ar-SA')}</div>
        <div class="subtitle">المرشد الطلابي: محمد القحطاني</div>
    </div>

    <div class="stats-grid">
        <div class="stat-item"><div class="stat-number">${stats['إجمالي الطلاب']}</div><div class="stat-label">إجمالي الطلاب</div></div>
        <div class="stat-item"><div class="stat-number">${stats['طلاب محتاجون مالياً']}</div><div class="stat-label">محتاجون مالياً</div></div>
        <div class="stat-item"><div class="stat-number">${stats['طلاب ذوو إعاقة']}</div><div class="stat-label">ذوو إعاقة</div></div>
        <div class="stat-item"><div class="stat-number">${stats['طلاب موهوبون']}</div><div class="stat-label">موهوبون</div></div>
        <div class="stat-item"><div class="stat-number">${stats['أيتام']}</div><div class="stat-label">أيتام</div></div>
        <div class="stat-item"><div class="stat-number">${stats['مشاكل نفسية']}</div><div class="stat-label">مشاكل نفسية</div></div>
    </div>

    <table>
        <thead>
            <tr>
                <th>اسم الطالب</th><th>رقم الهوية</th><th>الصف</th><th>الشعبة</th>
                <th>ولي الأمر</th><th>الجوال</th><th>الحالة الاقتصادية</th>
                <th>محتاج مالياً</th><th>الحي</th><th>الحالة الخاصة</th>
            </tr>
        </thead>
        <tbody>
            ${data.map(student => `
                <tr>
                    <td>${student.studentName}</td>
                    <td>${student.nationalId}</td>
                    <td>${student.grade}</td>
                    <td>${student.section}</td>
                    <td>${student.guardianName}</td>
                    <td>${student.guardianPhone}</td>
                    <td>${student.economicLevel || 'غير محدد'}</td>
                    <td>${student.financialNeed || 'غير محدد'}</td>
                    <td>${student.neighborhood || 'غير محدد'}</td>
                    <td>${getStudentStatus(student).text}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>

    <div class="page-break"></div>
    <div style="text-align:center;margin-top:50px;color:#666">
        <p>انتهى التقرير</p>
        <p style="font-size:12px">تم إنشاؤه بواسطة نظام إدارة بيانات الطلاب - تطوير نواف الصبحي</p>
    </div>
</body>
</html>`;
        }

        // باقي دوال التقارير
        function generateHealthDiseasesReport() { /* … */ }
        function generateEconomicReport()        { /* … */ }
        function generateHealthReport()          { /* … */ }
        function generateSocialReport()          { /* … */ }
        function generateTalentsReport()         { /* … */ }
        function generateAcademicReport()        { /* … */ }
        function generateCompleteReport()        { /* … */ }
        function showReportModal(reportData, reportType) { /* … */ }

        // باقي الوظائف المساعدة
        window.editStudent             = function(id) { alert('ميزة التعديل قيد التطوير …'); };
        window.printStudentDetails     = function()   { /* … */ };
        window.editStudentFromModal    = function()   { alert('ميزة التعديل قيد التطوير …'); };
        window.exportStudentData       = function()   { /* … */ };
        window.sendNotification        = function()   { alert('ميزة الإشعارات ستكون متوفرة قريباً …'); };
        window.closeModal              = function()   { document.getElementById('studentModal').style.display = 'none'; };

        // اختصارات لوحة المفاتيح + حفظ التفضيلات + مراقبة الأداء + معالجة الأخطاء
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeModal();
            if (e.ctrlKey && e.key === 'f') { e.preventDefault(); document.getElementById('searchInput').focus(); document.getElementById('searchInput').select(); }
            if (e.ctrlKey && e.key === 'r') { e.preventDefault(); refreshData(); }
            if (e.ctrlKey && e.key === 'e') { e.preventDefault(); exportFilteredData(); }
        });

        function saveSearchPreferences() { /* … */ }
        function loadSearchPreferences() { /* … */ }
        function addTooltips()           { /* … */ }

        // إنهاء التهيئة
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard().then(() => {
                setupEventListeners();
                loadSearchPreferences();
                addTooltips();
            });
        });

        console.log('✅ تم تحميل لوحة التحكم الكاملة مع تصدير الحالات المرضية');
    </script>
</body>
</html>
